package org.data7.bYD_WORLD_UTRAL;

import net.kyori.adventure.text.Component;
import net.kyori.adventure.text.event.ClickEvent;
import net.kyori.adventure.text.format.TextColor;
import org.bukkit.Bukkit;
import org.bukkit.Sound;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;

import java.io.File;
import java.util.UUID;

import static org.data7.bYD_WORLD_UTRAL.Tpa.*;

public final class BYD_WORLD_UTRAL extends JavaPlugin {

    @Override
    public void onEnable() {
        // Plugin startup logic
        getServer().getLogger().info("\n ____  _  _  ____        __  __  ____  ____    __    __   \n" +
                "(  _ \\( \\/ )(  _ \\      (  )(  )(_  _)(  _ \\  /__\\  (  )  \n" +
                " ) _ < \\  /  )(_) ) ___  )(__)(   )(   )   / /(__)\\  )(__ \n" +
                "(____/ (__) (____/ (___)(______) (__) (_)\\_)(__)(__)(____)");
        getServer().getLogger().info("BYD_WORLD_UTRAL is enabled!");
        String version = getDescription().getVersion();
        getServer().getLogger().info("Plugin version:" + "\033[1;34m" + version + "\033[0m");

        //ÈÖçÁΩÆÊñá‰ª∂
        File config = new File(getDataFolder(), "config.yml");
        if (!config.exists()) {
            saveResource("config.yml", false);
        }

        File broadcastFile = new File(getDataFolder(), "broadcast.yml");
        if (!broadcastFile.exists()) {
            saveResource("broadcast.yml", false);
        }
        File tpaFile = new File(getDataFolder(), "tpa.yml");
        if (!tpaFile.exists()) {
            saveResource("tpa.yml", false);
        }

        //Ê≥®ÂÜåÁõëÂê¨
        this.getServer().getPluginManager().registerEvents(new PlayerJoin.PlayerListener(), this);
        this.getServer().getPluginManager().registerEvents(new Playerdeath(), this);

        Tpa tpa = new Tpa();
        tpa.connect();
        tpa.InitialDB();

        this.getCommand("suicide").setExecutor(this);
        this.getCommand("tpa").setExecutor(this);
        this.getCommand("tpac").setExecutor(this);
    }

    @Override
    public void onDisable() {
        // Plugin shutdown logic
    }

    /**
     * @param sender  Source of the command
     * @param command Command which was executed
     * @param label   Alias of the command which was used
     * @param args    Passed command arguments
     * @return
     */
    @Override
    public boolean onCommand(CommandSender sender, Command command, String label, String[] args) {
        /**
         * Á¥´Á†Ç
         */
        if (label.equalsIgnoreCase("suicide")) {
            if (sender instanceof Player) {
                Player player = (Player) sender;
                Component suicideMessage = Component.text("üíÄ")
                        .append(Component.text(player.getName())
                                .color(TextColor.color(255, 255, 0))) // ËÆæÁΩÆÁé©ÂÆ∂ÂêçÂ≠ó‰∏∫ÈªÑËâ≤
                        .append(Component.text("Á¥´Á†Ç‰∫Ü!"));
                player.getServer().broadcast(suicideMessage);
                // Ëé∑ÂèñÊâÄÊúâÂú®Á∫øÁé©ÂÆ∂
                for (Player onlinePlayer : Bukkit.getOnlinePlayers()) {
                    // ‰∏∫ÊØè‰∏™Âú®Á∫øÁé©ÂÆ∂Êí≠ÊîæÈü≥Êïà
                    onlinePlayer.playSound(player.getLocation(), Sound.ENTITY_GENERIC_EXPLODE, 5f, 5f);
                }
                player.addScoreboardTag("suicide");
                player.setHealth(0);
                return true;
            }
        }
        /** TPA */
        if (label.equalsIgnoreCase("tpa")) {

            Tpa.TpaConfig tpaConfig = loadTpa();

            if (tpaConfig.isEnableTpa()) {
                if (sender instanceof Player) {
                    Player player = (Player) sender;

                    // Ê£ÄÊü•ÂèÇÊï∞Êï∞Èáè
                    if (args.length != 2) {
                        player.sendMessage(Component.text("‚ùéÂëΩ‰ª§Áî®Ê≥ïÈîôËØØÔºÅÊ≠£Á°ÆÊ†ºÂºè: /tpa to <Áé©ÂÆ∂Âêç> Êàñ /tpa come <Áé©ÂÆ∂Âêç>")
                                .color(TextColor.color(255, 0, 0)));
                        return true;
                    }

                    String subCommand = args[0];
                    String targetName = args[1];
                    Player targetPlayer = Bukkit.getPlayerExact(targetName); // Á≤æÁ°ÆÊü•ÊâæÁé©ÂÆ∂

                    // Ê£ÄÊü•ÁõÆÊ†áÁé©ÂÆ∂ÊòØÂê¶Âú®Á∫ø
                    if (targetPlayer == null || !targetPlayer.isOnline()) {
                        player.sendMessage(Component.text("‚ùéÊâæ‰∏çÂà∞Áé©ÂÆ∂: " + targetName)
                                .color(TextColor.color(255, 0, 0)));
                        return true;
                    }

                    UUID playercome; // ËØ∑Ê±ÇÂèëËµ∑ËÄÖ
                    UUID playerto;   // ËØ∑Ê±ÇÁõÆÊ†á

                    if (subCommand.equalsIgnoreCase("to")) {
                        playercome = player.getUniqueId();
                        playerto = targetPlayer.getUniqueId();

                        if (isOnCoolDown(playercome.toString(), tpaConfig.getCooldown(), tpaConfig.getReply()) == -1) {

                            if(tpaConfig.isConfirm()){
                                // ÂèëÈÄÅÊèêÁ§∫‰ø°ÊÅØ
                                player.sendMessage(Component.text("Â∑≤Âêë " + targetName + " ÂèëÈÄÅ‰º†ÈÄÅËØ∑Ê±ÇÔºà‰Ω†Â∞Ü‰º†ÈÄÅÂà∞ÂØπÊñπÔºâ"));
                                Component requestMessage = Component.text()
                                        .append(Component.text(player.getName(), TextColor.color(255, 255, 0))
                                                .append(Component.text(" ËØ∑Ê±Ç‰º†ÈÄÅÂà∞‰Ω†ËøôÈáå!", TextColor.color(255, 255, 225))))
                                        .build();
                                targetPlayer.sendMessage(requestMessage);

                                Component responseButtons = Component.text()
                                        .append(Component.text("[Êé•Âèó] ", TextColor.color(0, 255, 0))
                                                .clickEvent(ClickEvent.callback(clicker -> {
                                                    // Êé•ÂèóËØ∑Ê±ÇÂêéÁöÑÊ∂àÊÅØ
                                                    Component acceptTargetMsg = Component.text()
                                                            .append(Component.text(player.getName(), TextColor.color(255, 255, 0))
                                                                    .append(Component.text(" ‰º†ÈÄÅËøáÊù•‰∫Ü!", TextColor.color(255, 255, 225))))
                                                            .build();

                                                    Component acceptPlayerMsg = Component.text()
                                                            .append(Component.text(targetPlayer.getName(), TextColor.color(255, 255, 0))
                                                                    .append(Component.text(" ÂêåÊÑè‰∫Ü‰Ω†ÁöÑËØ∑Ê±Ç!", TextColor.color(255, 255, 225))))
                                                            .build();
                                                    tpa(playercome.toString(),playerto.toString());

                                                    targetPlayer.sendMessage(acceptTargetMsg);
                                                    player.sendMessage(acceptPlayerMsg);
                                                }))
                                                .append(Component.text(" "))
                                                .append(Component.text("[ÊãíÁªù]", TextColor.color(255, 0, 0))
                                                        .clickEvent(ClickEvent.callback(clicker -> {
                                                            // ÊãíÁªùËØ∑Ê±ÇÂêéÁöÑÊ∂àÊÅØ
                                                            Component rejectTargetMsg = Component.text()
                                                                    .append(Component.text("‰Ω†ÊãíÁªù‰∫Ü ", TextColor.color(255, 255, 225)))
                                                                    .append(Component.text(player.getName(), TextColor.color(255, 255, 0))
                                                                            .append(Component.text(" ÁöÑ‰º†ÈÄÅËØ∑Ê±Ç!", TextColor.color(255, 255, 225))))
                                                                    .build();

                                                            Component rejectPlayerMsg = Component.text()
                                                                    .append(Component.text(targetPlayer.getName(), TextColor.color(255, 255, 0))
                                                                            .append(Component.text(" ÊãíÁªù‰∫Ü‰Ω†ÁöÑËØ∑Ê±Ç!", TextColor.color(255, 255, 225))))
                                                                    .build();

                                                            targetPlayer.sendMessage(rejectTargetMsg);
                                                            player.sendMessage(rejectPlayerMsg);
                                                        }))))
                                        .build();

                                targetPlayer.sendMessage(responseButtons);
                            }
                            else {
                                Component acceptTargetMsg = Component.text()
                                        .append(Component.text(player.getName(), TextColor.color(255, 255, 0))
                                                .append(Component.text(" ‰º†ÈÄÅËøáÊù•‰∫Ü!", TextColor.color(255, 255, 225))))
                                        .build();

                                Component acceptPlayerMsg = Component.text()
                                        .append(Component.text("‰Ω†‰º†ÈÄÅÂà∞‰∫Ü ", TextColor.color(255, 255, 225)))
                                                .append(Component.text(targetPlayer.getName(), TextColor.color(255, 255, 0)))
                                        .build();
                                tpa(playercome.toString(),playerto.toString());

                                targetPlayer.sendMessage(acceptTargetMsg);
                                player.sendMessage(acceptPlayerMsg);
                            }

                        }

                    }
                    else if (subCommand.equalsIgnoreCase("come")) {
                        playerto = player.getUniqueId();
                        playercome = targetPlayer.getUniqueId();
                        if(tpaConfig.isConfirm()){
                            // ÂèëÈÄÅÊèêÁ§∫‰ø°ÊÅØ
                            player.sendMessage(Component.text("Â∑≤Âêë " + targetName + " ÂèëÈÄÅ‰º†ÈÄÅËØ∑Ê±ÇÔºàËØ∑Ê±ÇÂØπÊñπ‰º†ÈÄÅÂà∞‰Ω†Ôºâ"));
                            // ÊûÑÂª∫ËØ∑Ê±ÇÊ∂àÊÅØ
                            Component requestMessage = Component.text()
                                    .append(Component.text(player.getName(), TextColor.color(255, 255, 0)))
                                    .append(Component.text(" ËØ∑Ê±Ç‰Ω†‰º†ÈÄÅÂà∞TAÈÇ£Èáå!", TextColor.color(255, 255, 225)))
                                    .build();
                            targetPlayer.sendMessage(requestMessage);
                            // ÊûÑÂª∫‰∫§‰∫íÊåâÈíÆ
                            Component responseButtons = Component.text()
                                    .append(Component.text("[Êé•Âèó] ", TextColor.color(0, 255, 0))
                                            .clickEvent(ClickEvent.callback(clicker -> {
                                                // Êé•ÂèóËØ∑Ê±ÇÂêéÁöÑÊ∂àÊÅØ
                                                if (isOnCoolDown(playercome.toString(), tpaConfig.getCooldown(), tpaConfig.getReply()) == -1){
                                                    Component acceptTargetMsg = Component.text()
                                                            .append(Component.text("‰Ω†Â∑≤‰º†ÈÄÅÂà∞ ", TextColor.color(255, 255, 225)))
                                                            .append(Component.text(player.getName(), TextColor.color(255, 255, 0)))
                                                            .append(Component.text(" ÁöÑ‰ΩçÁΩÆ!", TextColor.color(255, 255, 225)))
                                                            .build();
                                                    Component acceptPlayerMsg = Component.text()
                                                            .append(Component.text(targetPlayer.getName(), TextColor.color(255, 255, 0)))
                                                            .append(Component.text(" Â∑≤‰º†ÈÄÅÂà∞‰Ω†ËøôÈáå!", TextColor.color(255, 255, 225)))
                                                            .build();
                                                    // ÊâßË°å‰º†ÈÄÅÔºàÂØπÊñπ‰º†ÈÄÅÂà∞Ëá™Â∑±Ôºâ
                                                    tpa(playercome.toString(), playerto.toString());
                                                    targetPlayer.sendMessage(acceptTargetMsg);
                                                    player.sendMessage(acceptPlayerMsg);
                                                }
                                            }))
                                            .append(Component.text(" "))
                                            .append(Component.text("[ÊãíÁªù]", TextColor.color(255, 0, 0))
                                                    .clickEvent(ClickEvent.callback(clicker -> {
                                                        // ÊãíÁªùËØ∑Ê±ÇÂêéÁöÑÊ∂àÊÅØ
                                                        Component rejectTargetMsg = Component.text()
                                                                .append(Component.text("‰Ω†ÊãíÁªù‰∫Ü ", TextColor.color(255, 255, 225)))
                                                                .append(Component.text(player.getName(), TextColor.color(255, 255, 0)))
                                                                .append(Component.text(" ÁöÑ‰º†ÈÄÅËØ∑Ê±Ç!", TextColor.color(255, 255, 225)))
                                                                .build();
                                                        Component rejectPlayerMsg = Component.text()
                                                                .append(Component.text(targetPlayer.getName(), TextColor.color(255, 255, 0)))
                                                                .append(Component.text(" ÊãíÁªù‰∫Ü‰Ω†ÁöÑ‰º†ÈÄÅËØ∑Ê±Ç!", TextColor.color(255, 255, 225)))
                                                                .build();
                                                        targetPlayer.sendMessage(rejectTargetMsg);
                                                        player.sendMessage(rejectPlayerMsg);
                                                    }))))
                                    .build();
                            targetPlayer.sendMessage(responseButtons);
                        }
                        else {
                            long timerest = isOnCoolDown(playercome.toString(), tpaConfig.getCooldown(), tpaConfig.getReply());
                            if (timerest == -1){
                                Component acceptTargetMsg = Component.text()
                                        .append(Component.text("‰Ω†Â∑≤‰º†ÈÄÅÂà∞ ", TextColor.color(255, 255, 225)))
                                        .append(Component.text(player.getName(), TextColor.color(255, 255, 0)))
                                        .append(Component.text(" ÁöÑ‰ΩçÁΩÆ!", TextColor.color(255, 255, 225)))
                                        .build();
                                Component acceptPlayerMsg = Component.text()
                                        .append(Component.text(targetPlayer.getName(), TextColor.color(255, 255, 0)))
                                        .append(Component.text(" Â∑≤‰º†ÈÄÅÂà∞‰Ω†ËøôÈáå!", TextColor.color(255, 255, 225)))
                                        .build();
                                // ÊâßË°å‰º†ÈÄÅÔºàÂØπÊñπ‰º†ÈÄÅÂà∞Ëá™Â∑±Ôºâ
                                tpa(playercome.toString(), playerto.toString());
                                targetPlayer.sendMessage(acceptTargetMsg);
                                player.sendMessage(acceptPlayerMsg);
                            }
                            else {
                                Component acceptTargetMsg1 = Component.text()
                                        .append(Component.text(player.getName(), TextColor.color(255, 255, 0)))
                                        .append(Component.text("ËØ∑Ê±Ç‰Ω†ÁöÑÊè¥Âä©! ‰ΩÜ‰Ω†ËøòÂú®ÂÜ∑Âç¥‰∏≠~", TextColor.color(255, 255, 225)))
                                        .build();
                                player.sendMessage(Component.text("‚ùéTA‰ªçÂú®ÂÜ∑Âç¥‰∏≠ÔºåÂâ©‰ΩôÊó∂Èó¥: ",TextColor.color(255,0,0)).append(Component.text(timerest + "s")));
                                targetPlayer.sendMessage(acceptTargetMsg1);
                            }

                        }
                    }
                    else {
                        player.sendMessage(Component.text("‚ùéÂëΩ‰ª§Áî®Ê≥ïÈîôËØØÔºÅÊ≠£Á°ÆÊ†ºÂºè: /tpa to <Áé©ÂÆ∂Âêç> Êàñ /tpa come <Áé©ÂÆ∂Âêç>")
                                .color(TextColor.color(255, 0, 0)));
                        return true;
                    }
                    return true;
                }
            } else return false;

        }
        return false;
    }

}
